
v=P38FmPAq09E

## DHCP
- 应用层协议
- 底层采用UDP，客户端使用68，服务端使用67端口；

客户端没有发出请求时，不知道网关地址，所以目标地址是广播地址255.255.255.255；
且客户端还没有获得局域网的IP，源IP也还没有(只有DHCP服务器分配后才有)，是0.0.0.0。

DHCP服务器 收到广播回复时，由于当初接受请求时没有“源IP”，所以回复的目标地址也是广播地址255.255.255.255；

家庭局域网，一般DHCP自动获取IP，12H续约。

## DNS
使用UDP的53号端口

客户端首次执行DNS时，向网关发送DNS请求；但该请求在链路层需要使用MAC地址，客户端只有网关的IP；需要ARP获得网关的MAC地址；

## ARP
客户端发出ARP请求，链路层封上自己的MAC地址，
源MAC是客户端自己，目标MAC还未确定，是全F的广播地址。交换机发现目标MAC是广播地址，会广播给所有节点；非网关节点会感知到“客户端”的IP及其MAC，并缓存到本地。
路由器收到广播后，发现目标IP是网关自己，就回应自己的MAC。

## NAT映射表
局域网内的某个主机 192.169.1.3 访问baidu.com；
路由器发现目标IP不是网关自己、是外网IP，向向外转发；源IP是192.169.1.3 无法在外网录音；
路由器向外转发时会将源IP改成网关的外网IP（路由器WAN口），且路由器从自身获取随机的端口 替换掉源端口；前后映射关系保存到NAT映射表<源IP，源端口，映射IP，映射端口>；
数据包的“回城”之旅：当百度回复数据时，数据包先回到路由器的 WAN 口，路由器收到回包，查NAT映射表，通过映射端口 查询这个请求是谁发的。路由器在将数据包的目标IP 从 WAN 口地址换回映射记录里的 192.168.1.3。

一个路由器会有2个IP：一个是wan口，被运营商的那个光猫分配的外网IP；一个是lan口，路由器自身的内网IP 192.168.1.1，局域网内连接这个路由器的设备都用这个内网IP作为网关，然后如果有设备要连接互联网的服务器，就先经过192.168.1.1的lan口，然后再通过路由器wan口发送给光猫，再通过光猫发往互联网。

光猫的模式
在现实中，这里有两种常见情况：
情况 A（路由模式）： 光猫自己也是个路由器，它分配给路由器 WAN 口的是另一个内网 IP（例如 192.168.0.x）。这就形成了“双重 NAT”。
情况 B（桥接模式）： 光猫只负责转换光信号，路由器 WAN 口直接通过拨号获得公网 IP。这是硬核玩家最喜欢的，因为网络效率更高，且方便内网穿透。

光猫在路由模式下，从功能上，可以不再需要另一个路由器了；但对网速敏感，需要再加一个。

TUN模式，会创建一张虚拟网卡；
在网络协议栈层面，拦截所有流量。
通过配置系统的路由表，接管所有流量。
软路由 安装clash，TUN对应的虚拟网卡直接放在路由器上。

TUN接近完美，网络层接管系统所有流量，在此基础上实现分流。
